# AWS Terraform Remote State with S3 and DynamoDB

Basic module to create remote state in AWS using S3 and DynamoDB.

- [Overview](#overview)
  - [Diagrams](#diagrams)
  - [References](#references)
    - [GitHub Repositories](#github-repositories)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
  - [Validate Terraform](#validate-terraform)
  - [Deploy from client machine](#deploy-from-client-machine)
  - [Troubleshooting Terraform](#troubleshooting-terraform)
  - [Destroy Environment](#destroy-environment)
- [Terraform Docs](#terraform-docs)

## Overview

### Diagrams

**Solution Architecture**

![Example](images/example.png)

### References

### GitHub Repositories

## Prerequisites

### Tooling
- Terraform
- Git
- AWS CLI
- Terraform-Docs
- TFLint
- TFEnv
- Checkov
- Pre-Commit

#### Configure AWS CLI
Run this command to quickly set and view your credentials, region, and output format\. The following example shows sample values\.

```
$ aws configure
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name [None]: us-west-2
Default output format [None]: json
```

 For example, the files generated by the CLI for a default profile configured with `aws configure` looks similar to the following\.

**`~/.aws/credentials`**

```
[default]
aws_access_key_id=AKIAIOSFODNN7EXAMPLE
aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

**`~/.aws/config`**

```
[default]
region=us-west-2
output=json
```

#### Install Required Version Of Terraform

```bash
tfenv install && tfenv use
```

## Quick Start

### Validate Terraform

Format
```bash
terraform fmt -recursive
```

Validate
```bash
terraform validate
```

Static Code Analysis
```bash
checkov -s -d .
```

Lint
```bash
tflint --init --loglevel=info
tflint --module --loglevel=info
```

Terraform-Docs
```bash
terraform-docs .
```

Pre-commit
```bash
pre-commit install
pre-commit run --all-files
```

### Deploy from client machine

Initialise the Terraform to install any modules and providers.

```bash
terraform init
```

Run terraform plan to check if any changes will be made to infrastructure.

```bash
terraform plan
```

Run terraform apply to deploy any changes to infrastructure.

```bash
terraform apply --auto-approve
```

### Troubleshooting Terraform

If the Terraform state is locked
```bash
terraform force-unlock <state-lock-id>
```

Listing available Terraform Workspaces
```bash
terraform workspace list
```

Upgrade Terraform Providers
```bash
terraform init --upgrade
git add .
git commit -m "upgrade terraform provider versions within pinned config"
git push
```

### Destroy Environment

To destroy a specific environment you need to run from a client machine.

Initialise the Terraform to install any modules and providers.

```bash
terraform init
```

Destroy the provisioned infrastructure in the target environment.

```bash
terraform destroy --auto-approve
```

## Terraform-Docs



<!-- BEGIN_TF_DOCS -->
#### Requirements

| Name | Version |
|------|---------|
| terraform | ~> 1.0 |
| aws | ~> 4.0 |

#### Providers

| Name | Version |
|------|---------|
| aws | ~> 4.0 |

#### Modules

No modules.

#### Resources

| Name | Type |
|------|------|
| [aws_dynamodb_table.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/dynamodb_table) | resource |
| [aws_s3_bucket.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket) | resource |
| [aws_s3_bucket_acl.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_acl) | resource |
| [aws_s3_bucket_logging.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_logging) | resource |
| [aws_s3_bucket_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_policy) | resource |
| [aws_s3_bucket_public_access_block.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_public_access_block) | resource |
| [aws_s3_bucket_server_side_encryption_configuration.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_server_side_encryption_configuration) | resource |
| [aws_s3_bucket_versioning.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_versioning) | resource |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_iam_policy_document.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |

#### Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| access_logging_target_bucket | Name of logging bukcet used for s3 access logging | `string` | `null` | no |
| name | Name of the DynamoDB table and S3 bucket used to store TF state | `string` | `"tf-state-bucket"` | no |

#### Outputs

| Name | Description |
|------|-------------|
| bucket | n/a |
<!-- END_TF_DOCS -->